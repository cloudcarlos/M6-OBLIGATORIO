<nav class="navbar navbar-expand-lg bg-body-tertiary shadow-lg mb-3">
  <div class="d-flex flex-wrap py-1">
    <a class="navbar-brand mx-3" href="#">API Animé</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-principal"
      aria-controls="navbar-principal" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar-principal">
      <ul class="navbar-nav mb-2 px-3 ">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/home">Inicio</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/animes/busqueda">Busqueda</a>
        </li>
        <li class="nav-item bg-success rounded">
          <button id="nuevo-anime-button" type="button" class="text-white btn btn-success text-decoration-none">Nuevo
            Anime</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

{{!-- modal-nuevo-anime' --}}

<div class="modal fade" id="modal-nuevo-anime" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
  data-bs-focus="true" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down modal-lg"
    role="document">
    <div class="modal-content">
      <form id="nuevo-anime-form" class="m-0 p-0">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitleId">Nuevo Anime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body col-12 col-md-8 col-lg-6 justify-content-center mx-auto">
          {{!-- nombre --}}
          <div class="form-floating mb-3">
            <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Dragon Ball" required>
            <label for="nombre">Nombre</label>
          </div>
          {{!-- autor --}}
          <div class="form-floating mb-3">
            <input type="text" class="form-control" name="autor" id="autor" placeholder="Akira Toriyama" required>
            <label for="autor">Autor</label>
          </div>
          {{!-- año --}}
          <div class="form-floating mb-3">
            <select class="form-select" id="año" name="año" required> </select>
            <label for="año">Año de lanzamiento</label>
          </div>
          {{!-- genero --}}
          <div class="form-floating mb-3">
            <select class="form-select" id="genero" name="genero" required> </select>
            <label for="genero">Genero</label>
          </div>
          {{!-- acciones --}}
          <div class="modal-footer justify-content-lg-evenly justify-content-center">
            <button type="submit" class="btn btn-success">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>

        </div>
      </form>
    </div>

  </div>
</div>

<script>

  const nuevoAnimeButton = document.getElementById("nuevo-anime-button");
  const nuevoAnimeForm = document.getElementById("nuevo-anime-form");
  const modalAnime = document.getElementById('modal-nuevo-anime')

  /////////////////////////////////
  //input genero
  const generos = [
    "Acción", "Suspenso", "Drama", "Aventura",
    "Ciencia ficción", "Acción sobrenatural",
    "Magia", "Fantasía", "Horror", "Deporte",
  ];

  function renderizarAnimeModal(modal) {
    const form = modal
    //input genero
    const selectGenero = form.querySelector('select[name="genero"]');
    generos.forEach(genero => {
      const option = document.createElement('option');
      option.value = genero;
      option.textContent = genero.toWellFormed().toUpperCase();
      selectGenero.appendChild(option);
    });

    //input año
    const selectAño = nuevoAnimeForm.querySelector('select[name="año"]');
    const esteAnio = new Date().getFullYear();
    const anioMinimo = 1900;
    for (let i = esteAnio; i >= anioMinimo; i--) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      selectAño.appendChild(option);
    };
    return;
  }

  nuevoAnimeButton.addEventListener("click", event => {
    event.preventDefault();
    const modalShow = new bootstrap.Modal(modalAnime);
    renderizarAnimeModal(nuevoAnimeForm)
    modalShow.show();
    console.log("modal Done!");
    return
  });

  nuevoAnimeForm.addEventListener("submit", async (event) => {
    console.log('HAHA')
    event.preventDefault();
    //nombre,genero,año,autor

    const nuevoUsuario = new FormData(nuevoAnimeForm);
    const delta = {
      nombre: nuevoUsuario.get("nombre"),
      genero: nuevoUsuario.get("genero"),
      año: nuevoUsuario.get("año"),
      autor: nuevoUsuario.get("autor"),
    }
    try {

      const response = await fetch('/api/v1/animes/', {
        method: 'POST',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(delta),
        redirect: "manual",
      });

      if (response.status === 201) {
        alert(response.statusText)
        location.reload();
      }
    }
    catch (error) {
      alert(error.message)
    }
  });

</script>